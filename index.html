<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Schedule Sorter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2CANVAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
 <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&family=Gloria+Hallelujah&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">


<!-- PDF.js (Matched Versions) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>



    <script>


   tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                        // NEW FONTS ADDED HERE:
                        hand: ['"Gloria Hallelujah"', 'cursive'],
                        cyber: ['"Orbitron"', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'bounce-slow': 'bounce 3s infinite', // Added for the floating button
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }






        
    </script>
       <style>
      /* --- 1. BASE STYLES --- */
    body { background-color: #030712; color: white; overflow-x: hidden; font-family: 'Plus Jakarta Sans', sans-serif; }
    :root { --theme-primary: #3b82f6; --theme-secondary: #a855f7; }

    /* --- 2. THE ARTBOARD (Wallpaper Canvas) --- */
  #scheduleContainer {
    margin: 0 auto !important;
    /* Use rgba so we can see the blobs behind the schedule */
    background-color: rgba(3, 7, 18, 0.6) !important; 
    backdrop-filter: blur(8px); /* Optional: adds a nice glass effect */
    position: relative;
    display: block !important; 
    transition: width 0.3s ease, padding 0.3s ease;
    box-sizing: border-box;
    padding: 20px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Ensure the background blobs are actually behind everything */
.ambient-light {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* Behind the schedule */
    pointer-events: none;
}
    














    /* --- 3. THE LAYOUT ENGINE --- */
    .day-section { width: 100%; margin-bottom: 1.5rem; padding: 0 20px; box-sizing: border-box; }
    .day-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .card-grid { display: grid !important; gap: 10px; width: 100%; align-items: stretch; }

    /* Grid Helpers */
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    /* --- 4. CARDS (The Text-Safe Logic) --- */
    .card-draggable { 
        cursor: grab; transition: transform 0.2s, opacity 0.2s; touch-action: none; 
        width: 100%; min-width: 0; height: auto !important; display: flex; flex-direction: column; 
        user-select: none; border-radius: 12px;
    }
    .card-draggable h4 {
        display: block !important; white-space: normal !important; overflow: visible !important;
        word-break: break-word !important; line-height: 1.2 !important; font-size: 11px !important;
        font-weight: 700; margin-bottom: 4px;
    }
    .dragging { opacity: 0.3; transform: scale(0.95); border: 2px dashed var(--theme-primary) !important; }

    /* --- 5. UI COMPONENTS --- */
    .glass-panel { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .glass-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s; }
    .text-gradient { background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
</style>



</head>
<body class="selection:bg-indigo-500 selection:text-white min-h-screen flex flex-col">

    <div class="ambient-light">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
    </div>

    <!-- Main Content Wrapper -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-10 md:py-16 w-full">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6 animate-fade-up">
            <div class="relative">
                <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight mb-2">
                    Study Load <br> <span class="text-gradient">Sorter AI</span>
                </h1>
                <p class="text-slate-400 font-light text-lg">Paste text. Choose design. Save image.</p>
            </div>
            
<!-- PDF UPLOAD BUTTON -->
      <label class="cursor-pointer glass-btn px-5 py-3 rounded-full flex items-center gap-2 group">
                <i class="fa-solid fa-file-pdf text-red-500"></i>
                <span id="pdfLabel" class="text-sm font-semibold tracking-wide text-slate-300 group-hover:text-white">Upload PDF</span>
                <input type="file" id="pdfUpload" accept=".pdf" class="hidden" onchange="handlePDF(this)">
            </label>



            <div class="flex gap-3">
                <button onclick="toggleVideo()" class="glass-btn px-5 py-3 rounded-full flex items-center gap-2 group">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-sm font-semibold tracking-wide text-slate-300 group-hover:text-white">Watch Tutorial</span>
                </button>
                <button onclick="loadExample()" class="glass-btn px-5 py-3 rounded-full flex items-center gap-2">
                    <i class="fa-solid fa-code text-blue-400"></i>
                    <span class="text-sm font-semibold tracking-wide text-slate-300">Sample</span>
                </button>
            </div>
        </header>

        <!-- Input Section -->
        <div class="glass-panel rounded-3xl p-1 mb-16 animate-fade-in">
            <div class="bg-[#0f172a]/60 rounded-[20px] p-6 md:p-10 relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>

                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-bold uppercase tracking-[0.2em] text-slate-400">Paste Schedule Table</label>
                    <div class="flex gap-2">
                        <button onclick="clearData()" class="text-[10px] bg-red-500/10 border border-red-500/30 text-red-400 px-3 py-1 rounded hover:bg-red-500/20 transition">
                            <i class="fa-solid fa-trash"></i> Clear
                        </button>
                        <div class="text-[10px] bg-slate-800 border border-slate-700 px-2 py-1 rounded text-slate-400 font-mono">
                            CTRL + V
                        </div>
                    </div>
                </div>

                <textarea id="rawInput" class="w-full h-40 bg-transparent resize-none text-sm md:text-base font-mono text-slate-200 placeholder-slate-600 border-b border-slate-700 focus:border-blue-500 transition-colors" 
                placeholder="Paste directly from your study load...&#10;41200 CC-TECHNO32 3 MWF 3:30 PM - 4:30 PM"></textarea>

                <div class="mt-8 flex justify-end">
                    <button id="genBtn" onclick="processSchedule()" class="relative overflow-hidden bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-xl transition-all hover:shadow-[0_0_30px_rgba(59,130,246,0.4)] active:scale-95 group">
                        <span class="relative z-10 flex items-center gap-2">
                            Generate <i class="fa-solid fa-bolt"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTROL BAR (Design & Department) -->
        <div id="toolbar" class="hidden mb-8 animate-fade-in">
            <div class="glass-panel p-4 rounded-xl flex flex-col xl:flex-row justify-between items-center gap-4">
                
                <!-- Department Theme -->
                <div class="flex items-center gap-2 w-full xl:w-auto">
                    <span class="text-xs font-bold text-slate-400 uppercase">Dept:</span>
                    <select id="deptSelect" onchange="changeTheme(this.value)" class="bg-slate-800 text-white text-sm rounded-lg p-2 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 flex-1">
                        <option value="BSIT">BSIT / CCS</option>
                        <option value="MARITIME">Maritime</option>
                        <option value="ENGINEERING">Engineering</option>
                        <option value="CUSTOMS">Customs</option>
                        <option value="EDUCATION">Education</option>
                    </select>
                </div>

                <!-- Design Picker -->
                <div class="flex items-center gap-2 w-full xl:w-auto bg-slate-900/50 p-1 rounded-lg">


<div class="flex items-center gap-2 w-full xl:w-auto bg-slate-900/50 p-1 rounded-lg">
    <button onclick="setLayout('desktop')" id="btn-mode-pc" class="flex-1 px-4 py-1.5 text-xs font-bold rounded-md bg-blue-600 text-white shadow">
        Desktop View
    </button>
    <button onclick="setLayout('mobile')" id="btn-mode-mobile" class="flex-1 px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-white">
        Mobile Designer
    </button>
</div>

                    <button onclick="setDesign('glass')" id="btn-glass" class="flex-1 px-4 py-1.5 text-xs font-bold rounded-md bg-blue-600 text-white shadow">
                        <i class="fa-regular fa-gem mr-1"></i> Glass
                    </button>
                    <button onclick="setDesign('paper')" id="btn-paper" class="flex-1 px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-white">
                        <i class="fa-regular fa-file-lines mr-1"></i> Paper
                    </button>
                  
                </div>

           <!-- ADVANCED WALLPAPER DESIGNER -->
<div id="layoutControls" class="hidden flex flex-col gap-4 w-full xl:w-auto bg-slate-900/90 p-5 rounded-3xl border border-white/10 backdrop-blur-xl mb-6">
    <!-- 1. Layout Density -->
    <div class="flex flex-col gap-1">
        <label class="text-[9px] text-slate-500 uppercase font-bold">Layout Density</label>
        <div class="flex bg-black/40 p-1 rounded-xl gap-1">
            <button onclick="changeDensity(1)" id="den-1" class="flex-1 py-1.5 text-[10px] font-bold rounded-lg text-slate-400">List</button>
            <button onclick="changeDensity(2)" id="den-2" class="flex-1 py-1.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white shadow">Grid</button>
        </div>
    </div>
    <!-- 2. Card Size -->
    <div class="flex flex-col gap-1">
        <label class="text-[9px] text-slate-500 uppercase font-bold">Zoom Cards</label>
        <input type="range" min="0.5" max="1" step="0.05" value="0.9" class="cursor-pointer accent-emerald-500" oninput="adjustCanvas('scale', this.value)">
    </div>
    <!-- 3. Canvas Width -->
    <div class="flex flex-col gap-1">
        <label class="text-[9px] text-slate-500 uppercase font-bold">Wallpaper Width</label>
        <input type="range" min="350" max="600" value="450" class="cursor-pointer accent-purple-500" oninput="adjustCanvas('width', this.value)">
    </div>
    <!-- 4. Clock Space -->
    <div class="flex flex-col gap-1">
        <label class="text-[9px] text-slate-500 uppercase font-bold">Top Space (Clock)</label>
        <input type="range" min="0" max="300" value="80" class="cursor-pointer accent-blue-500" oninput="adjustCanvas('top', this.value)">
    </div>
</div>




                <!-- Download -->
                <button onclick="downloadImage()" class="w-full xl:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 transition">
                    <i class="fa-solid fa-download"></i> Save Image
                </button>
            </div>
        </div>

        <!-- Output Grid (The part that gets saved) -->
        <div id="scheduleContainer" class="p-4 rounded-2xl bg-[#030712] relative transition-colors duration-500">
            <div id="resultArea" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 pb-8">
                <!-- Columns injected by JS -->
            </div>

            <!-- WATERMARK -->
            <div id="watermark" class="hidden text-center pt-6 border-t border-slate-800/50 mt-4">
                <p class="text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                    <i class="fa-solid fa-microchip mr-1"></i> Powered by CMOB Department
                </p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20 opacity-30 animate-pulse">
            <i class="fa-solid fa-layer-group text-6xl mb-4 text-slate-400"></i>
            <p class="text-slate-400 text-sm tracking-widest uppercase">Waiting for data...</p>
        </div>

    </main>






 <!-- NEW: FLOATING CUSTOMIZE BUTTON -->
    <button id="fabCustomize" onclick="openTemplateModal()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-purple-600 hover:bg-purple-500 text-white rounded-full shadow-2xl z-50 flex items-center justify-center text-xl transition hover:scale-110 active:scale-90 animate-bounce">
        <i class="fa-solid fa-palette"></i>
    </button>

    <!-- NEW: TEMPLATE GALLERY MODAL -->
    <div id="templateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="absolute inset-0" onclick="closeTemplateModal()"></div>
        <div class="glass w-full max-w-4xl h-[80vh] rounded-2xl flex flex-col relative z-10">
            <div class="p-5 border-b border-white/10 flex justify-between items-center">
                <h3 class="font-bold text-xl text-white">Select a Design Style</h3>
                <button onclick="closeTemplateModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    <!-- Cosmic (Default) -->
    <div onclick="setDesign('cosmic')" class="cursor-pointer group">
        <div class="bg-[#030712] border border-blue-500/50 h-32 rounded-xl flex items-center justify-center font-bold text-white group-hover:ring-2 ring-blue-500 transition">Cosmic Glass</div>
        <p class="text-xs text-center text-slate-400 mt-2">Default Dark Mode</p>
    </div>
    <!-- Clean Paper -->
    <div onclick="setDesign('paper')" class="cursor-pointer group">
        <div class="bg-white border border-gray-300 h-32 rounded-xl flex items-center justify-center font-bold text-gray-800 group-hover:ring-2 ring-gray-400 transition shadow-lg">Clean Paper</div>
        <p class="text-xs text-center text-slate-400 mt-2">Minimalist Light</p>
    </div>
    <!-- Cyberpunk -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">GE HIMO PA</span>
        </div>
        <div class="bg-black border-2 border-green-500 h-32 flex items-center justify-center font-bold text-green-500 font-mono">CYBERPUNK</div>
        <p class="text-xs text-center text-slate-500 mt-2">High Contrast Neon</p>
    </div>

    <!-- Sketchbook -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">Not Available Yet</span>
        </div>
        <div class="bg-[#fef9c3] border border-yellow-600 h-32 rounded-sm flex items-center justify-center font-bold text-slate-700 font-serif">Sketchbook</div>
        <p class="text-xs text-center text-slate-500 mt-2">Handwritten Style</p>
    </div>

    <!-- Blueprint -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">Not Available Yet</span>
        </div>
        <div class="bg-[#1e3a8a] border border-blue-300/30 h-32 rounded-sm flex items-center justify-center font-bold text-blue-100 font-mono">Blueprint</div>
        <p class="text-xs text-center text-slate-500 mt-2">Technical Grid</p>
    </div>

    <!-- Stealth Dark -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">Not Available Yet</span>
        </div>
        <div class="bg-[#111111] border border-white/10 h-32 rounded-3xl flex items-center justify-center font-bold text-slate-400">Stealth Dark</div>
        <p class="text-xs text-center text-slate-500 mt-2">Minimalist Dark</p>
    </div>

    <!-- Soft Rose -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">Not Available Yet</span>
        </div>
        <div class="bg-[#fff1f2] border border-rose-200 h-32 rounded-full flex items-center justify-center font-bold text-rose-400">Soft Rose</div>
        <p class="text-xs text-center text-slate-500 mt-2">Aesthetic Light</p>
    </div>

    <!-- Modern Pro -->
    <div class="relative cursor-not-allowed group opacity-50 grayscale">
        <div class="absolute inset-0 z-20 flex items-center justify-center">
            <span class="bg-red-600/90 text-white text-[9px] font-black px-2 py-1 rounded tracking-tighter uppercase rotate-[-10deg]">Not Available Yet</span>
        </div>
        <div class="bg-white border-t-8 border-blue-600 h-32 shadow-xl flex items-center justify-center font-bold text-slate-800">Modern Pro</div>
        <p class="text-xs text-center text-slate-500 mt-2">Clean Professional</p>
    </div>
</div>

     </div>
    </div>














    <!-- FOOTER -->
    <footer class="border-t border-slate-800/50 py-8 bg-[#020617] relative z-10">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm font-medium">
                Powered by 
                <span class="ml-1 font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                    <i class="fa-solid fa-microchip mr-1"></i> CMOB Department
                </span>
            </p>
            <p class="text-[10px] text-slate-600 mt-2 font-mono">&copy; 2026. Built for UC Students.</p>
        </div>
    </footer>

    <!-- VIDEO MODAL -->
    <div id="videoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 transition-opacity duration-300">
        <div class="absolute inset-0" onclick="toggleVideo()"></div>
        <div class="glass-panel w-full max-w-4xl rounded-2xl overflow-hidden relative z-10">
            <div class="flex justify-between items-center p-5 border-b border-white/10 bg-white/5">
                <h3 class="font-bold text-white">How to Use</h3>
                <button onclick="toggleVideo()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex p-2 bg-slate-900/50 gap-2 border-b border-white/5">
                <button onclick="switchTab('mobile')" id="btn-mobile" class="glass-btn tab-active flex-1 py-3 text-sm font-bold rounded-lg">Mobile</button>
                <button onclick="switchTab('desktop')" id="btn-desktop" class="glass-btn tab-inactive flex-1 py-3 text-sm font-bold rounded-lg">Desktop</button>
            </div>
            <div class="p-4 bg-black/40">
                <div id="view-mobile">
                    <div class="aspect-video bg-black rounded-lg overflow-hidden border border-slate-700 mb-3 relative">
                        <video id="vid-mobile" class="w-full h-full object-contain" controls playsinline>
                            <source src="mon.mp4" type="video/mp4">
                        </video>
                    </div>
                    <p class="text-xs text-slate-400 text-center font-mono">Tip: Open PDF > Copy Text > Paste Here.</p>
                </div>
                <div id="view-desktop" class="hidden">
                    <div class="aspect-video bg-black rounded-lg overflow-hidden border border-slate-700 mb-3 relative">
                        <video id="vid-desktop" class="w-full h-full object-contain" controls playsinline>
                            <source src="2026-01-20 12-21-41.mp4" type="video/mp4">
                        </video>
                    </div>
                    <p class="text-xs text-slate-400 text-center font-mono">Tip: Portal > Copy (Ctrl+C) > Paste (Ctrl+V).</p>
                </div>
            </div>
        </div>
    </div>

        <script>
            // GLOBAL STATE
            let currentTemplate = 'cosmic';
            let parsedData = { mwf: [], tth: [], sat: [] };
            let currentDesign = 'glass'; // glass, paper, cyber
            let currentColor = 'emerald'; // Default
        
        let canvasSettings = { width: 420, cols: 2, scale: 0.9, top: 80, mode: 'desktop' };
        


 // --- UNIFIED DESIGN LOGIC ---
function setDesign(style) {
    // 1. Logic Sync: Map 'glass' button to 'cosmic' template
    const templateName = (style === 'glass') ? 'cosmic' : style;
    currentTemplate = templateName;

    // 2. Indicator Fix: Update Button Colors
    const designButtons = ['glass', 'paper'];
    designButtons.forEach(id => {
        const btn = document.getElementById(`btn-${id}`);
        if (btn) {
            if (id === style) {
                // Make this button blue
                btn.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md bg-blue-600 text-white shadow";
            } else {
                // Make other buttons grey
                btn.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-white";
            }
        }
    });

    // 3. Update Visuals
    updateContainerStyle(templateName);
    renderAll();
    
    if(typeof closeTemplateModal === 'function') closeTemplateModal();
}

// Ensure the Modal buttons also work
function applyTemplate(style) { setDesign(style); }

function updateContainerStyle(style) {
    const container = document.getElementById('scheduleContainer');
    const watermark = document.getElementById('watermark');
    const blobs = container.querySelector('.ambient-light');

    // Reset Defaults
    container.style = ""; 
    container.className = "p-4 rounded-2xl relative overflow-hidden transition-all duration-500";
    if (blobs) blobs.style.display = 'none';

    if (style === 'paper') {
        container.style.backgroundColor = '#ffffff';
        watermark.className = "text-center pt-6 border-t border-gray-200 mt-4 text-[10px] text-gray-400 font-bold uppercase";
   
    } else if (style === 'notebook') {
        container.style.backgroundColor = '#fef9c3';
        container.style.backgroundImage = 'linear-gradient(#e5e7eb 1px, transparent 1px)';
        container.style.backgroundSize = '20px 20px';
    } else if (style === 'blueprint') {
        container.style.backgroundColor = '#172554';
        container.style.backgroundImage = 'radial-gradient(#3b82f6 1px, transparent 1px)';
        container.style.backgroundSize = '20px 20px';
    } else if (style === 'stealth') {
        container.style.backgroundColor = '#0a0a0a';
    } else if (style === 'rose') {
        container.style.backgroundColor = '#fff1f2';
    } else if (style === 'pro') {
        container.style.backgroundColor = '#f8fafc';
        container.style.borderTop = '10px solid #2563eb';
    } else {
        // Cosmic (Default Glass)
        container.style.backgroundColor = '#030712';
        if (blobs) blobs.style.display = 'block';
    }
}
            



            
    // --- 1. COORDINATE-SORTED PDF READER (WITH SMART WELDING) ---
            async function handlePDF(input) {
                const file = input.files[0];
                if (!file) return;

                const labelSpan = document.getElementById('pdfLabel');
                const originalContent = labelSpan.innerHTML;
                labelSpan.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> Reading PDF...`;

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = "";

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        
                        let items = textContent.items.sort((a, b) => {
                            if (Math.abs(a.transform[5] - b.transform[5]) > 4) return b.transform[5] - a.transform[5];
                            return a.transform[4] - b.transform[4];
                        });

                        let lastY = -1;
                        let lastX = -1;
                        for (let item of items) {
                            let currentX = item.transform[4];
                            let currentY = item.transform[5];

                            if (lastY !== -1 && Math.abs(currentY - lastY) > 4) {
                                fullText += "\n";
                            } 
                            else if (lastX !== -1 && (currentX - lastX) > 6) { 
                                fullText += " "; 
                            }

                            fullText += item.str;
                            lastY = currentY;
                            lastX = currentX + (item.width || 0);
                        }
                    }

                    // 1. Put text in the box
                    document.getElementById('rawInput').value = fullText;
                    
                    // 2. Feedback only - Removed processSchedule() so it waits for click
                    labelSpan.innerHTML = `<i class="fa-solid fa-check"></i> Ready to Generate!`;
                    
                    setTimeout(() => {
                        labelSpan.innerHTML = originalContent;
                        input.value = ''; 
                    }, 3000);

                } catch (error) {
                    alert("PDF Error: " + error.message);
                    labelSpan.innerHTML = originalContent;
                }
            }

















            // THEMES
            const themes = {
                BSIT: { primary: '#3b82f6', secondary: '#a855f7', button: 'bg-blue-600' },
                MARITIME: { primary: '#0ea5e9', secondary: '#1e3a8a', button: 'bg-sky-600' },
                ENGINEERING: { primary: '#f97316', secondary: '#dc2626', button: 'bg-orange-600' },
                CUSTOMS: { primary: '#10b981', secondary: '#0f766e', button: 'bg-emerald-600' },
                EDUCATION: { primary: '#ec4899', secondary: '#be123c', button: 'bg-pink-600' }
            };

            // --- INIT ---
            window.onload = function() {
                const savedData = localStorage.getItem('uc_schedule_data');
                const savedTheme = localStorage.getItem('uc_theme') || 'BSIT';
                document.getElementById('deptSelect').value = savedTheme;
                changeTheme(savedTheme);
                if(savedData) {
                    document.getElementById('rawInput').value = savedData;
                    processSchedule();
                }
            }

            // --- THEME ENGINE ---
            function changeTheme(dept) {
                const theme = themes[dept];
                const root = document.documentElement;
                localStorage.setItem('uc_theme', dept);
                root.style.setProperty('--theme-primary', theme.primary);
                root.style.setProperty('--theme-secondary', theme.secondary);
                const btn = document.getElementById('genBtn');
                btn.className = btn.className.replace(/bg-\w+-600/g, ''); 
                btn.classList.add(theme.button);
            }

            

    // --- 2. THE UNIFIED FUZZY PROCESSOR ---
    function processSchedule() {
        const raw = document.getElementById('rawInput').value;
        if (!raw.trim()) return;

        localStorage.setItem('uc_schedule_data', raw);
        parsedData = { mwf: [], tth: [], sat: [] };
        
        // 1. Get Student Name (Header Logic)
        const nameMatch = raw.match(/Name\s*[:\s]*([^(\n|]+)/i);
        if (nameMatch) {
            studentName = nameMatch[1].replace(/Name/gi, '').trim().split('(')[0].trim();
        }

        const lines = raw.split('\n');
        let foundCount = 0;

        lines.forEach(line => {
            // Clean line noise and standardize dashes
            const cleanLine = line.replace(/[–—]/g, '-').trim();

            // ANCHORS: We need an EDP (5 digits) and a Time (00:00 AM - 00:00 PM)
            const edpMatch = cleanLine.match(/\b\d{5}\b/);
            const timeMatch = cleanLine.match(/(\d{1,2}:\d{2}\s*[AP]M\s*-\s*\d{1,2}:\d{2}\s*[AP]M)/i);

            if (edpMatch && timeMatch) {
                const edp = edpMatch[0];
                const time = timeMatch[0].toUpperCase();

                // Find Day Pattern
                const dayMatch = cleanLine.match(/\b(MWF|TTH|SAT|MW|TUE|THU|FRI|S|M|W|F|T|TH)\b/i);
                const days = dayMatch ? dayMatch[0].toUpperCase() : "MWF";

                // SUBJECT EXTRACTION (Fuzzy Logic)
                // We know Subject is between the EDP and the Day/Time
                let midPart = cleanLine.split(days)[0].replace(edp, '').trim();
                
                // Remove the Units digit (usually a 1, 2, or 3 right before the days)
                let subject = midPart.replace(/\s*[1-5]\s*$/, '').trim();
                
                // ROOM EXTRACTION
                // Room is usually the first word after the Time string
                let afterTime = cleanLine.split(time)[1].trim();
                let room = afterTime.split(/\s+/)[0] || "TBA";

                // If the room grabbed the Course (like CBE-506BSMA), slice it
                // UC Rooms are usually 7 characters or less
                if (room.length > 8 && /[A-Z]{2,}$/.test(room)) {
                    room = room.match(/^[A-Z0-9-]+/i)[0];
                }

                // TYPE DETECTION
                let type = "LEC";
                if (cleanLine.toUpperCase().includes("LAB") || cleanLine.match(/\bL\b/)) {
                    type = "LAB";
                }

                // SORTING & GROUPING
                let group = 'mwf';
                if (days.includes('TTH') || /^(T|TH|TUE|THU)$/.test(days)) group = 'tth';
                else if (days.includes('SAT') || days === 'S') group = 'sat';

                parsedData[group].push({
                    edp, 
                    subject: subject || "Untitled Subject", 
                    time, 
                    room, 
                    type,
                    sort: parseTime(time.split('-')[0])
                });
                foundCount++;
            }
        });

        if (foundCount > 0) {
            // Finalize UI
            const sorter = (a, b) => a.sort - b.sort;
            parsedData.mwf.sort(sorter); 
            parsedData.tth.sort(sorter); 
            parsedData.sat.sort(sorter);

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('toolbar').classList.remove('hidden');
            document.getElementById('fabCustomize').classList.remove('hidden');
            
            
            renderAll();
        } else {
            alert("System failed to detect table rows. Please try to copy-paste the text manually.");
        }
    }

    function updateHeaderTitle() {
        let container = document.getElementById('scheduleContainer');
        let titleEl = document.getElementById('schedTitle');
        if(!titleEl) {
            titleEl = document.createElement('div');
            titleEl.id = 'schedTitle';
            titleEl.className = "mb-8 p-6 border-b border-white/10 text-center";
            container.prepend(titleEl);
        }
        titleEl.innerHTML = `
            <p class="text-[10px] uppercase tracking-[0.3em] text-blue-400 mb-1">Official Study Load</p>
            <h2 class="text-2xl font-black text-white uppercase">${studentName}</h2>
        `;
    }

    // Helper to show the hidden UI elements
    function showResultUI() {
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('toolbar').classList.remove('hidden');
        document.getElementById('fabCustomize').classList.remove('hidden');
        
        // Set Student Name as Title
        const container = document.getElementById('scheduleContainer');
        let title = document.getElementById('dynTitle');
        if (!title) {
            title = document.createElement('h2');
            title.id = 'dynTitle';
            title.className = "text-center text-2xl font-black text-white mb-6 uppercase tracking-widest";
            container.prepend(title);
        }
        title.innerText = studentName;
    }

    function parseTime(t) {
        let [time, mod] = t.split(/([AP]M)/i);
        let [h, m] = time.trim().split(':').map(Number);
        if(h === 12) h = 0; if(mod.toUpperCase() === 'PM') h += 12;
        return h * 60 + m;
    }

    // --- 3. UI RENDERER ---
    function updateUI() {
        // Sort
        const sorter = (a, b) => a.sort - b.sort;
        parsedData.mwf.sort(sorter); 
        parsedData.tth.sort(sorter); 
        parsedData.sat.sort(sorter);

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('toolbar').classList.remove('hidden');
        document.getElementById('fabCustomize').classList.remove('hidden');

        // Update Header with Student Name
        const container = document.getElementById('scheduleContainer');
        let titleEl = document.getElementById('schedTitle');
        if(!titleEl) {
            titleEl = document.createElement('div');
            titleEl.id = 'schedTitle';
            titleEl.className = "mb-8 p-6 border-b border-white/10 text-center";
            container.prepend(titleEl);
        }
        titleEl.innerHTML = `
            <p class="text-[10px] uppercase tracking-[0.3em] text-blue-400 mb-1">Official Study Load</p>
            <h2 class="text-2xl font-black text-white uppercase">${studentName}</h2>
        `;
        
        renderAll(); 
    }



    function changeDensity(val) {
        canvasSettings.cols = val;
        // Update button colors
        document.getElementById('den-1').className = val == 1 ? "flex-1 py-1.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white shadow" : "flex-1 py-1.5 text-[10px] font-bold rounded-lg text-slate-400";
        document.getElementById('den-2').className = val == 2 ? "flex-1 py-1.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white shadow" : "flex-1 py-1.5 text-[10px] font-bold rounded-lg text-slate-400";
        renderAll();
    }

        // --- RENDER ENGINE (DESIGNER VERSION) ---

    function renderAll() {
        const container = document.getElementById('resultArea');
        container.innerHTML = ''; 
        container.className = "flex flex-col w-full"; // Stack day groups vertically

        const days = [
            { id: 'mwf', title: 'Mon / Wed / Fri', data: parsedData.mwf, color: 'emerald' },
            { id: 'tth', title: 'Tue / Thu', data: parsedData.tth, color: 'amber' },
            { id: 'sat', title: 'Saturday', data: parsedData.sat, color: 'pink' }
        ];

        days.forEach(dayGroup => {
            if (dayGroup.data.length === 0) return;

            const daySection = document.createElement('div');
            daySection.className = "day-section w-full mb-8";
            
            // PC Mode = 3 columns, Designer Mode = User Choice (1 or 2)
            const colCount = canvasSettings.mode === 'desktop' ? 3 : canvasSettings.cols;

            daySection.innerHTML = `
                <div class="flex items-center gap-2 mb-4 border-b border-white/10 pb-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-${dayGroup.color}-500"></div>
                    <h2 class="text-[11px] font-black text-slate-300 uppercase tracking-widest">${dayGroup.title}</h2>
                </div>
                <div class="card-grid grid grid-cols-${colCount} gap-3 items-start"></div>
            `;

            const grid = daySection.querySelector('.card-grid');
            dayGroup.data.forEach(c => {
                grid.innerHTML += generateCardHTML(c, dayGroup.color);
            });

            container.appendChild(daySection);
        });

        initDragAndDrop(); 
        syncCanvas();
    }

  function generateCardHTML(c, themeColor) {
    const borderCol = themeColor === 'emerald' ? '#10b981' : (themeColor === 'amber' ? '#f59e0b' : '#ec4899');
    
    // THEME: CLEAN PAPER
    if (currentTemplate === 'paper') {
        return `<div draggable="true" class="card-draggable bg-white border border-gray-200 p-3 shadow-sm mb-1 text-gray-800">
            <h4 class="font-bold text-[11px] border-b pb-1 mb-1">${c.subject}</h4>
            <p class="text-[9px] opacity-70">${c.time} | ${c.room}</p>
        </div>`;
    } 
    
    // THEME: CYBERPUNK (This fixes the empty result)
    if (currentTemplate === 'cyber') {
        return `<div draggable="true" class="card-draggable bg-black border border-green-500/50 p-3 mb-1 text-green-400 font-mono">
            <h4 class="text-[10px] font-black tracking-tighter uppercase">${c.subject}</h4>
            <p class="text-[8px] mt-1">> ${c.time}</p>
            <p class="text-[8px] opacity-50">LOC: ${c.room}</p>
        </div>`;
    }

    // THEME: STEALTH DARK
    if (currentTemplate === 'stealth') {
        return `<div draggable="true" class="card-draggable bg-[#1a1a1a] border border-white/5 p-4 rounded-3xl mb-1 text-slate-300">
            <h4 class="text-[11px] font-medium">${c.subject}</h4>
            <p class="text-[9px] opacity-40 mt-1">${c.time}</p>
        </div>`;
    }

    // THEME: SOFT ROSE
    if (currentTemplate === 'rose') {
        return `<div draggable="true" class="card-draggable bg-white p-4 rounded-full border border-rose-100 shadow-sm mb-1 text-center">
            <h4 class="text-rose-500 font-bold text-[10px]">${c.subject}</h4>
            <p class="text-rose-300 text-[8px] uppercase tracking-widest">${c.time}</p>
        </div>`;
    }

    // THEME: MODERN PRO
    if (currentTemplate === 'pro') {
        return `<div draggable="true" class="card-draggable bg-white p-3 border shadow-sm mb-1 flex items-center gap-3">
            <div class="w-1 h-10 bg-blue-600"></div>
            <div><h4 class="text-slate-900 font-bold text-[11px]">${c.subject}</h4>
            <p class="text-slate-500 text-[9px]">${c.time} • ${c.room}</p></div>
        </div>`;
    }

    // DEFAULT: COSMIC GLASS
    return `<div draggable="true" class="card-draggable glass-panel p-4 rounded-2xl border border-white/5 text-white mb-1">
        <div class="absolute left-0 top-0 bottom-0 w-1" style="background:${borderCol}"></div>
        <h4 class="font-bold text-[11px] leading-tight">${c.subject}</h4>
        <div class="flex justify-between mt-2 opacity-60 text-[9px] font-mono"><span>${c.time}</span><span>${c.room}</span></div>
    </div>`;
}


    function initDragAndDrop() {
        const draggables = document.querySelectorAll('.card-draggable');
        const zones = document.querySelectorAll('.card-grid'); // Drop into the grids inside days

        draggables.forEach(draggable => {
            // MOUSE
            draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
            draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));

            // TOUCH (Mobile)
            draggable.addEventListener('touchstart', (e) => {
                draggable.classList.add('dragging');
            }, { passive: true });
            
            draggable.addEventListener('touchend', () => {
                draggable.classList.remove('dragging');
            });

            draggable.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const zone = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.card-grid');
                if (zone) {
                    const afterElement = getDragAfterElement(zone, touch.clientY);
                    const dragging = document.querySelector('.dragging');
                    if (afterElement == null) zone.appendChild(dragging);
                    else zone.insertBefore(dragging, afterElement);
                }
            }, { passive: false });
        });


    grids.forEach(grid => {
            grid.addEventListener('dragover', e => {
                e.preventDefault();
                const draggable = document.querySelector('.dragging');
                const afterElement = getDragAfterElement(grid, e.clientY);
                if (afterElement == null) grid.appendChild(draggable);
                else grid.insertBefore(draggable, afterElement);
            });
        });




        zones.forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(zone, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) zone.appendChild(dragging);
                else zone.insertBefore(dragging, afterElement);
            });
        });
    }





    // --- HELPER: This keeps your card designs clean and in one place ---
    function generateCardHTML(c, dayColor = 'blue') {
        // A. COSMIC GLASS
        if(currentTemplate === 'cosmic') {
            return `
            <div draggable="true" class="card-draggable glass-panel p-5 rounded-2xl relative overflow-hidden group mb-4">
                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-400"></div>
                <div class="pl-2">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-mono text-[10px] text-slate-400 bg-slate-900 px-1.5 py-0.5 rounded">${c.edp}</span>
                            <h4 class="font-bold text-white text-sm mt-1">${c.subject}</h4>
                        </div>
                        <span class="text-[10px] font-bold border border-slate-600 text-slate-400 px-1.5 py-0.5 rounded">${c.type}</span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-300">
                        <span class="text-blue-300"><i class="fa-regular fa-clock"></i> ${c.time}</span>
                        <span><i class="fa-solid fa-location-dot text-slate-500"></i> ${c.room}</span>
                    </div>
                </div>
            </div>`;
        } 
        // B. CLEAN PAPER
        else if(currentTemplate === 'paper') {
            return `
            <div draggable="true" class="card-draggable bg-white border-l-4 border-blue-500 shadow-sm p-4 rounded-lg mb-4">
                <h4 class="font-extrabold text-gray-800 text-sm uppercase">${c.subject}</h4>
                <div class="mt-2 flex items-center justify-between text-xs text-gray-600 font-mono">
                    <span class="font-bold">${c.time}</span>
                    <span class="bg-gray-100 px-2 rounded">${c.room}</span>
                </div>
            </div>`;
        }

        if (currentTemplate === 'cyber') {
        return `<div draggable="true" class="card-draggable bg-black border border-green-500/50 p-3 mb-1 text-green-400 font-mono">
            <h4 class="text-[10px] uppercase font-black tracking-tighter">${c.subject}</h4>
            <p class="text-[8px] mt-1">> ${c.time}</p>
            <p class="text-[8px] opacity-50">LOC: ${c.room}</p>
        </div>`;
    }
        // (Add your other templates here following the same 'draggable="true"' and 'card-draggable' pattern)
        return ''; // Fallback
    }

            // --- UTILS ---
            function parseTime(t) {
                let [time, mod] = t.split(/([AP]M)/i);
                let [h, m] = time.trim().split(':').map(Number);
                if(h === 12) h = 0; if(mod.toUpperCase() === 'PM') h += 12;
                return h * 60 + m;
            }

    function syncCanvas() {
        const container = document.getElementById('scheduleContainer');
        const resultArea = document.getElementById('resultArea');

        if(canvasSettings.mode === 'mobile') {
            container.style.width = canvasSettings.width + "px";
            container.style.paddingTop = canvasSettings.top + "px";
            container.style.margin = "0 auto";
            resultArea.style.zoom = canvasSettings.scale;
            
            // Use Scale to prevent text squeezing
            document.querySelectorAll('.card-draggable').forEach(card => {
                card.style.transform = `scale(${canvasSettings.scale})`;
            });
        } else {
            container.style.width = "100%";
            container.style.paddingTop = "20px";
        }
    }


    function adjustCanvas(type, val) {
        canvasSettings[type] = val;
        const container = document.getElementById('scheduleContainer');
        
        if (type === 'width') container.style.width = val + "px";
        if (type === 'top') container.style.paddingTop = val + "px";
        
        if (type === 'cols') {
            // We re-render to update the grid classes
            renderAll();
        }
        
        if (type === 'scale') {
            // Instead of scaling individual cards, we scale the whole Result Area
            // This is much cleaner and prevents "breaking"
            document.getElementById('resultArea').style.transform = `scale(${val})`;
            document.getElementById('resultArea').style.transformOrigin = "top center";
        }
    }   

    function setLayout(mode) {
        canvasSettings.mode = mode;
        const controls = document.getElementById('layoutControls');
        const container = document.getElementById('scheduleContainer');
        const btnPc = document.getElementById('btn-mode-pc');
        const btnMob = document.getElementById('btn-mode-mobile');

        if (mode === 'desktop') {
            // --- 1. DESKTOP MODE ---
            controls.classList.add('hidden'); // Hide sliders
            container.style.width = "100%";
            container.style.maxWidth = "1200px";
            container.style.paddingTop = "20px";
            container.style.zoom = "1";
            
            // Update Buttons
            btnPc.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md bg-blue-600 text-white shadow";
            btnMob.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-white";
        } else {
            // --- 2. MOBILE DESIGNER MODE ---
            controls.classList.remove('hidden'); // Show sliders
            container.style.maxWidth = "none";
            
            // Update Buttons
            btnMob.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md bg-blue-600 text-white shadow";
            btnPc.className = "flex-1 px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-white";
            
            // Apply slider values
            syncCanvas(); 
        }
        renderAll();
    }






    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.card-draggable:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }





    function downloadImage() {
    const element = document.getElementById('scheduleContainer');
    const watermark = document.getElementById('watermark');
    watermark.classList.remove('hidden');

    const btn = document.querySelector('button[onclick="downloadImage()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> Capturing...`;

    // Calculate current design width
    const capWidth = canvasSettings.mode === 'mobile' ? parseInt(canvasSettings.width) : 1200;

    html2canvas(element, {
        backgroundColor: currentTemplate === 'paper' || currentTemplate === 'pro' ? '#ffffff' : (currentTemplate === 'cyber' ? '#000000' : '#030712'),
        scale: 3, 
        useCORS: true, 
        allowTaint: true, 
        width: element.offsetWidth,
        height: element.offsetHeight,
        onclone: (cloned) => {
            // This forces the saved version to reset zoom so text isn't cut off
            const root = cloned.getElementById('scheduleContainer');
            const res = cloned.getElementById('resultArea');
            root.style.zoom = "1";
            root.style.width = capWidth + "px";
            res.style.zoom = "1";
            res.style.transform = "none";
        }
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `UC_Schedule_${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        
        btn.innerHTML = originalText;
        watermark.classList.add('hidden');
    });
}







            function loadExample() {
                const ex = `EDP Code Subject Type Units Days Time Room
    41200 CC-TECHNO32 3 MWF 3:30 PM - 4:30 PM A2-404 BSIT
    17192 IT-ELECT2 2 SAT 8:30 AM - 10:30 AM M1 BSIT
    17200 IT-ELECT2 L 1 SAT 10:30 AM - 1:30 PM C1 BSIT
    17128 IT-SYSADMN32 LAB 1 MWF 11:30 AM - 12:30 PM C1 BSIT`;
                document.getElementById('rawInput').value = ex;
            }

            function switchTab(mode) {
                const mobileView = document.getElementById('view-mobile');
                const desktopView = document.getElementById('view-desktop');
                const mobileBtn = document.getElementById('btn-mobile');
                const desktopBtn = document.getElementById('btn-desktop');
                document.getElementById('vid-mobile').pause();
                document.getElementById('vid-desktop').pause();

                if (mode === 'mobile') {
                    mobileView.classList.remove('hidden'); desktopView.classList.add('hidden');
                    mobileBtn.className = "glass-btn tab-active flex-1 py-3 text-sm font-bold rounded-lg transition-all";
                    desktopBtn.className = "glass-btn tab-inactive flex-1 py-3 text-sm font-bold rounded-lg transition-all";
                } else {
                    desktopView.classList.remove('hidden'); mobileView.classList.add('hidden');
                    desktopBtn.className = "glass-btn tab-active flex-1 py-3 text-sm font-bold rounded-lg transition-all";
                    mobileBtn.className = "glass-btn tab-inactive flex-1 py-3 text-sm font-bold rounded-lg transition-all";
                }
            }

        function toggleVideo() {
        const modal = document.getElementById('videoModal');
        // Try to find the inner content for animation, but don't crash if missing
        const content = document.getElementById('modalContent'); 

        // 1. If the main modal container is missing, we can't do anything.
        if (!modal) {
            console.error("Error: ID 'videoModal' not found in HTML.");
            return;
        }

        if (modal.classList.contains('hidden')) {
            // --- OPENING ---
            modal.classList.remove('hidden');
            
            // Only animate if the inner box exists
            if (content) {
                setTimeout(() => { 
                    content.classList.remove('scale-95', 'opacity-0'); 
                    content.classList.add('scale-100', 'opacity-100'); 
                }, 10);
            }
        } else {
            // --- CLOSING ---
            
            // 1. Animate out if possible
            if (content) {
                content.classList.remove('scale-100', 'opacity-100'); 
                content.classList.add('scale-95', 'opacity-0');
            }
            
            // 2. Safe Video Pause (Checks if elements exist before pausing)
            const vidMob = document.getElementById('vid-mobile');
            const vidDesk = document.getElementById('vid-desktop');
            if (vidMob) vidMob.pause();
            if (vidDesk) vidDesk.pause();

            // 3. Hide the modal after a short delay
            setTimeout(() => { 
                modal.classList.add('hidden'); 
            }, 300);
        }
    }

            function clearData() {
                if(confirm("Clear your saved schedule?")) {
                    localStorage.removeItem('uc_schedule_data');
                    document.getElementById('rawInput').value = '';
                    location.reload();
                }
            }







            // --- NEW DESIGN ENGINE ---
    function openTemplateModal() { document.getElementById('templateModal').classList.remove('hidden'); }
    function closeTemplateModal() { document.getElementById('templateModal').classList.add('hidden'); }

    function applyTemplate(style) {
        currentTemplate = style;
        closeTemplateModal();
        // Re-render the cards with the new design
        renderAll(); 
        updateContainerStyle(style);
    }

    function updateContainerStyle(style) {
        currentTemplate = style;
        const container = document.getElementById('scheduleContainer');
        const watermark = document.getElementById('watermark');

        // Reset styles
        container.style.backgroundImage = 'none';
        container.style.border = '1px solid rgba(255,255,255,0.05)';

        if (style === 'paper') {
            container.style.backgroundColor = '#ffffff'; // Solid white for paper
            watermark.className = "text-center pt-6 border-t border-gray-200 mt-4 text-[10px] text-gray-400 font-bold uppercase";
        } else if (style === 'cyber') {
            container.style.backgroundColor = '#000000'; // Solid black for cyber
            container.style.border = '2px solid #22c55e';
            watermark.className = "text-center pt-6 border-t border-green-900 mt-4 text-[10px] text-green-500 font-mono";
        } else if (style === 'notebook') {
            container.style.backgroundColor = '#fef9c3';
            container.style.backgroundImage = 'linear-gradient(#e5e7eb 1px, transparent 1px)';
            container.style.backgroundSize = '20px 20px';
            watermark.className = "text-center pt-6 border-t border-slate-300 mt-4 text-[10px] text-slate-500 font-serif";
        } else if (style === 'blueprint') {
            container.style.backgroundColor = '#172554';
            container.style.backgroundImage = 'radial-gradient(#3b82f6 1px, transparent 1px)';
            container.style.backgroundSize = '20px 20px';
            watermark.className = "text-center pt-6 border-t border-blue-400/30 mt-4 text-[10px] text-blue-200 font-mono";
        } else {
            // --- COSMIC GLASS (The Blob View) ---
            // We use rgba 0.6 so the blue/purple blobs show through from the back
            container.style.backgroundColor = 'rgba(3, 7, 18, 0.6)';
            watermark.className = "text-center pt-6 border-t border-dashed border-white/10 mt-4 text-[10px] text-slate-500 font-mono uppercase";
        }
    }






        </script>
</body>
</html> 
